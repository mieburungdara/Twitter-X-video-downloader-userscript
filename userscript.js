// ==UserScript==
// @name        XMaster: Power Tools for X (Twitter)
// @description        The script enhances Twitter (X) and TikTok by improving features such as date format, image and video downloads, and more for Twitter (X), and video downloads for TikTok. It will be continuously maintained and updated, so you can use it with confidence.
// @namespace   enochLiu_self_script
// @version     1.1.9
// @author      ThalixMurne,PeterParker
// @icon        data:image/png;base64,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
// @include     https://x.com/*
// @include     https://twitter.com/*
// @include     https://mobile.x.com/*
// @include     https://www.tiktok.com/**
// @exclude     *://x.com/i/flow/*
// @license     MIT
// @run-at      document-start
// @antifeature referral-link
// @noframes
// @grant       GM_registerMenuCommand
// @grant       GM_openInTab
// @grant       GM.openInTab
// @grant       GM_addStyle
// @grant       GM_setValue
// @grant       GM_getValue
// @grant       GM_deleteValue
// @grant       GM_xmlhttpRequest
// @grant       GM_download
// @grant       GM_setClipboard
// @downloadURL https://update.greasyfork.org/scripts/527918/XMaster%3A%20Power%20Tools%20for%20X%20%28Twitter%29.user.js
// @updateURL https://update.greasyfork.org/scripts/527918/XMaster%3A%20Power%20Tools%20for%20X%20%28Twitter%29.meta.js
// ==/UserScript==
(function () {
  'use strict';

  var css_248z$1 = "li[role=listitem]>div>div>div>div:not(:last-child){filter:none}li[role=listitem]>div>div>div>div+div:last-child{display:none}";

  var css_248z = ".x-master-dl{margin-left:12px;order:99}.x-master-dl:hover>div>div>div>div{color:#1da1f2}.x-master-dl:hover>div>div>div>div>div{background-color:#1da1f21a}.x-master-dl:active>div>div>div>div>div{background-color:#1da1f233}.x-master-dl:hover svg{color:#1da1f2}.x-master-dl:hover div:first-child:not(:last-child){background-color:#1da1f21a}.x-master-dl:active div:first-child:not(:last-child){background-color:#1da1f233}.x-master-dl.tmd-media{position:absolute;right:0}.x-master-dl.tmd-media>div{border-radius:99px;display:flex;margin:2px}.x-master-dl.tmd-media>div>div{color:#fff;display:flex;margin:6px}.x-master-dl.tmd-media:hover>div{background-color:#fff9}.x-master-dl.tmd-media:hover>div>div{color:#1da1f2}.x-master-dl.tmd-media:not(:hover)>div>div{filter:drop-shadow(0 0 1px #000)}.x-master-dl g{display:none}.x-master-dl.completed g.completed,.x-master-dl.download g.download,.x-master-dl.failed g.failed,.x-master-dl.loading g.loading{display:unset}.x-master-dl.loading svg{animation:spin 1s linear infinite}.x-master-dl.download g.download{color:#1da1f2}.tmd-btn{background-color:#1da1f2;border-radius:99px;color:#fff;padding:0 20px}.tmd-btn,.tmd-tag{display:inline-block}.tmd-tag{background-color:#fff;border:1px solid #1da1f2;border-radius:10px;color:#1da1f2;font-weight:700;margin:5px;padding:0 10px}.tmd-btn:hover{background-color:#1da1f2e6}.tmd-tag:hover{background-color:#1da1f21a}.tmd-notifier{background:#fff;border:1px solid #ccc;border-radius:8px;bottom:16px;color:#000;display:none;left:16px;padding:4px;position:fixed}.tmd-notifier.running{align-items:center;display:flex}.tmd-notifier label{align-items:center;display:inline-flex;margin:0 8px}.tmd-notifier label:before{background-position:50%;background-repeat:no-repeat;content:\" \";height:16px;width:32px}.tmd-notifier label:first-child:before{background-image:url(\"data:image/svg+xml;charset=utf8,<svg xmlns=%22http://www.w3.org/2000/svg%22 width=%2216%22 height=%2216%22 viewBox=%220 0 24 24%22><path d=%22M3,14 v5 q0,2 2,2 h14 q2,0 2,-2 v-5 M7,10 l4,4 q1,1 2,0 l4,-4 M12,3 v11%22 fill=%22none%22 stroke=%22%23666%22 stroke-width=%222%22 stroke-linecap=%22round%22 /></svg>\")}.tmd-notifier label:nth-child(2):before{background-image:url(\"data:image/svg+xml;charset=utf8,<svg xmlns=%22http://www.w3.org/2000/svg%22 width=%2216%22 height=%2216%22 viewBox=%220 0 24 24%22><path d=%22M12,2 a1,1 0 0 1 0,20 a1,1 0 0 1 0,-20 M12,5 v7 h6%22 fill=%22none%22 stroke=%22%23999%22 stroke-width=%222%22 stroke-linejoin=%22round%22 stroke-linecap=%22round%22 /></svg>\")}.tmd-notifier label:nth-child(3):before{background-image:url(\"data:image/svg+xml;charset=utf8,<svg xmlns=%22http://www.w3.org/2000/svg%22 width=%2216%22 height=%2216%22 viewBox=%220 0 24 24%22><path d=%22M12,0 a2,2 0 0 0 0,24 a2,2 0 0 0 0,-24%22 fill=%22%23f66%22 stroke=%22none%22 /><path d=%22M14.5,5 a1,1 0 0 0 -5,0 l0.5,9 a1,1 0 0 0 4,0 z M12,17 a2,2 0 0 0 0,5 a2,2 0 0 0 0,-5%22 fill=%22%23fff%22 stroke=%22none%22 /></svg>\")}.x-master-dl.tmd-img{bottom:0;display:none!important;position:absolute;right:0}.x-master-dl.tmd-img>div{background-color:#fff9;border-radius:99px;display:flex;margin:2px}.x-master-dl.tmd-img>div>div{color:#fff!important;display:flex;margin:6px}.x-master-dl.tmd-img:not(:hover)>div>div{filter:drop-shadow(0 0 1px #000)}.x-master-dl.tmd-img:hover>div>div{color:#1da1f2}.tmd-img.completed,.tmd-img.failed,.tmd-img.loading,:hover>.x-master-dl.tmd-img{display:block!important}.tweet-detail-action-item{width:20%!important}@keyframes spin{0%{transform:rotate(0deg)}to{transform:rotate(1turn)}}";

  const ScriptConst = {
    "lang": (navigator.language || navigator.userLanguage || "").slice(0, 2).toLowerCase() || "en",
    "isDev": false,
    "isDebug": false,
    "version": "1.0.1",
    "number": "11",
    "currentHost": window.location.host,
    "currentUrl": window.location.href
  };
  const PlatformConst = {
    "x": { "p": "x", "match": /twitter|x\.com$/ },
    "youtube": { "p": "youtube", "match": /youtube\.com$/ },
    "tiktok": { "p": "tiktok", "match": /www\.tiktok\.com/ },
    "cobalt": { "p": "cobalt", "match": /cobalt\.tools/ }
  };

  var __async$2 = (__this, __arguments, generator) => {
    return new Promise((resolve, reject) => {
      var fulfilled = (value) => {
        try {
          step(generator.next(value));
        } catch (e) {
          reject(e);
        }
      };
      var rejected = (value) => {
        try {
          step(generator.throw(value));
        } catch (e) {
          reject(e);
        }
      };
      var step = (x) => x.done ? resolve(x.value) : Promise.resolve(x.value).then(fulfilled, rejected);
      step((generator = generator.apply(__this, __arguments)).next());
    });
  };
  const Tools = {
    decryptStr: function(str) {
      try {
        if (!str) {
          return str;
        }
        let result = atob(str);
        return result.split("").reverse().join("");
      } catch (e) {
      }
      return null;
    },
    encryptStr: function(str) {
      try {
        if (!str) {
          return str;
        }
        let result = str.split("").reverse().join("");
        return btoa(result);
      } catch (e) {
      }
      return null;
    },
    getOtherPlatform: function() {
      let platform = null;
      const currentHost = window.location.host;
      for (let key in PlatformConst) {
        if (PlatformConst[key].match.test(currentHost)) {
          platform = PlatformConst[key].p;
          break;
        }
      }
      return platform;
    },
    removeAnchorsByNode: function(node) {
      const tagName = node.tagName;
      if (!tagName)
        return;
      const exist = ["A", "IMG", "DIV", "SPAN", "LABEL", "TABLE", "TR", "TD", "CANVAS"].some((name) => name === tagName);
      if (exist) {
        node.removeAttribute("data-spm-anchor-id");
        for (let i = 0; i < node.childNodes.length; i++) {
          this.removeAnchorsByNode(node.childNodes[i]);
        }
      }
    },
    openInTab: function(url, options = { "active": true, "insert": true, "setParent": true }) {
      if (typeof GM_openInTab === "function") {
        GM_openInTab(url, options);
      } else {
        GM.openInTab(url, options);
      }
    },
    onPageLoad: function(callback) {
      if (document.readyState === "complete") {
        callback();
      } else {
        window.addEventListener("DOMContentLoaded", callback, { once: true });
        window.addEventListener("load", callback, { once: true });
      }
    },
    request: function(method, url, param, headers = { "Content-Type": "application/json;charset=UTF-8" }, timeout = 20 * 1e3) {
      if (!url) {
        return Promise.reject({ "code": "exception", "result": null });
      }
      return new Promise((resolve, reject) => {
        const config = {
          method: method.toUpperCase(),
          url,
          timeout,
          onload: function(response) {
            if (response.status >= 200 && response.status < 300) {
              resolve({ "code": "success", "result": response.responseText });
            } else {
              reject({ "code": "error", "result": response.statusText });
            }
          },
          ontimeout: function(error) {
            reject({ "code": "error", "result": error });
          },
          onerror: function(error) {
            reject({ "code": "error", "result": error });
          }
        };
        if (config.method === "POST") {
          config.headers = headers != null ? headers : { "Content-Type": "application/json" };
          if (JSON.stringify(config.headers).indexOf("application/json") != -1) {
            config.data = JSON.stringify(param);
          } else {
            config.data = param;
          }
        } else if (config.method === "GET") {
          config.headers = headers != null ? headers : { "Content-Type": "application/json" };
          config.data = param;
        }
        GM_xmlhttpRequest(config);
      });
    },
    crossRequest: function(method = "GET", url, param = {}, headers = { "Content-Type": "application/json;charset=UTF-8" }, timeout = 20 * 1e3) {
      if (!url) {
        return Promise.reject({ "code": "exception", "result": null });
      }
      const config = { method: method.toUpperCase(), headers };
      const controller = new AbortController();
      const signal = controller.signal;
      config.signal = signal;
      if (config.method === "POST") {
        config.headers = headers != null ? headers : { "Content-Type": "application/json" };
        config.body = JSON.stringify(param);
      }
      const timeoutId = setTimeout(() => controller.abort(), timeout);
      return fetch(url, config).then((response) => response.ok ? response.text() : Promise.reject(response.statusText)).then((result) => {
        clearTimeout(timeoutId);
        return { "code": "success", "result": result };
      }).catch((error) => {
        clearTimeout(timeoutId);
        if (error.name === "AbortError") {
          return { "code": "error", "result": "Request timeout" };
        }
        return { "code": "error", "result": error };
      });
    },
    getGoodsIdByLink: function(url = window.location.href) {
      if (url.indexOf("?") != -1) {
        url = url.split("?")[0];
      }
      if (url.indexOf("#") != -1) {
        url = url.split("#")[0];
      }
      const suffix = "html|htm|id|p";
      let regex = new RegExp("\\/([^\\/]*?)\\.(" + suffix + ")");
      if (/lazada\./.test(url)) {
        regex = new RegExp("-i(\\d+)(?:-s(\\d+))?\\.html");
      } else if (/ebay\./.test(url)) {
        regex = new RegExp("\\/itm\\/(\\d+)");
      } else if (/banggood\./.test(url)) {
        regex = new RegExp("-p-(\\d+)\\.html");
      } else if (/amazon\./.test(url)) {
        regex = new RegExp("\\/(?:dp|gp\\/product|gp\\/aw\\/d|gp\\/offer-listing)\\/([A-Za-z0-9]{8,15})");
      }
      const match = url.match(regex);
      return match ? match[1] : null;
    },
    getParamterBySearch: function(paramsString = window.location.href, tag) {
      if (paramsString.indexOf("?") != -1) {
        paramsString = paramsString.split("?")[1];
      }
      const params = new URLSearchParams(paramsString);
      return params.get(tag);
    },
    waitForElementByInterval: function(selector, target = document.body, allowEmpty = true, delay = 10, maxDelay = 10 * 1e3) {
      return new Promise((resolve, reject) => {
        let totalDelay = 0;
        let element = target.querySelector(selector);
        let result = allowEmpty ? !!element : !!element && !!element.innerHTML;
        if (result) {
          resolve(element);
        }
        const elementInterval = setInterval(() => {
          if (totalDelay >= maxDelay) {
            clearInterval(elementInterval);
            resolve(null);
          }
          element = target.querySelector(selector);
          result = allowEmpty ? !!element : !!element && !!element.innerHTML;
          if (result) {
            clearInterval(elementInterval);
            resolve(element);
          } else {
            totalDelay += delay;
          }
        }, delay);
      });
    },
    randomNumber: function() {
      return Math.ceil(Math.random() * 1e8);
    },
    elementInContainer: function(container, element) {
      return container.contains(element);
    },
    mustGetElement: function(handler) {
      return __async$2(this, null, function* () {
        const getElements = (handler2) => __async$2(this, null, function* () {
          const promiseArray = [];
          const handlers = handler2.split("@");
          for (let i = 0; i < handlers.length; i++) {
            const eleName = handlers[i];
            if (!eleName) {
              continue;
            }
            if (eleName == "body") {
              promiseArray.push(
                new Promise((resolve, reject) => {
                  resolve(document.body);
                })
              );
            } else if (eleName == "html") {
              promiseArray.push(
                new Promise((resolve, reject) => {
                  resolve(document.html);
                })
              );
            } else {
              promiseArray.push(this.waitForElementByInterval(eleName, document.body, true, 10, 1500));
            }
          }
          let element2 = yield Promise.race(promiseArray);
          return element2;
        });
        let element = yield getElements(handler);
        return new Promise((resolve, reject) => {
          if (element) {
            resolve(element);
            return;
          }
          const waitInterval = setInterval(() => {
            element = getElements(handler);
            if (element) {
              clearInterval(waitInterval);
              resolve(element);
              return;
            }
          }, 2e3);
        });
      });
    },
    loopTask: function(callback, delay = 1500) {
      callback();
      setInterval(() => {
        callback();
      }, delay);
    },
    distinguishRemoveAndTry: function(distinguish, callback) {
      const distinguishElements = distinguish.map((name) => document.querySelector("*[name='" + name + "']"));
      const validateRs = distinguishElements.some((ele) => ele === null || ele === void 0);
      if (validateRs) {
        distinguishElements.reverse().forEach((element) => {
          if (element) {
            element.remove();
          }
        });
        callback();
      }
    },
    getDomain: function(url) {
      try {
        const hostname = new URL(url).hostname;
        const parts = hostname.split(".");
        if (parts.length > 2) {
          return `${parts[parts.length - 2]}.${parts[parts.length - 1]}`;
        }
        return hostname;
      } catch (error) {
        return null;
      }
    },
    getCommonMarketplace: function(url = window.location.href) {
      try {
        const domainParts = new URL(url).hostname.split(".");
        const countryCode = domainParts[domainParts.length - 1];
        return countryCode;
      } catch (error) {
      }
      return null;
    },
    getDocumentBody: function() {
      return new Promise((resolve, reject) => {
        if (document.body) {
          resolve(document.body);
          return;
        }
        const checkBody = setInterval(function() {
          if (document.body) {
            clearInterval(checkBody);
            resolve(document.body);
          }
        }, 50);
      });
    }
  };

  var _a;
  const language = {
    "zh": {
      "dateFormat": {
        "week": ["Êó•", "‰∏Ä", "‰∫å", "‰∏â", "Âõõ", "‰∫î", "ÂÖ≠"]
      },
      "download": {
        "download": "‰∏ãËΩΩ",
        "completed": "‰∏ãËΩΩÂÆåÊàê",
        "tip": "ÁÇπÂáª‰∏ãËΩΩËßÜÈ¢ë",
        "preparing": "Ê≠£Âú®ÂáÜÂ§á‰∏ãËΩΩÔºàÂ¶ÇÊûúÂ§±Ë¥•ÔºåËØ∑ÊâãÂä®Êìç‰ΩúÔºâ"
      },
      "menuCommand": {
        "settings": "ËÆæÁΩÆ",
        "titleDateFormat": "Êó∂Èó¥Ê†ºÂºèËÆæÁΩÆÔºö",
        "buttonClose": "ÂÖ≥Èó≠"
      }
    },
    "en": {
      "dateFormat": {
        "week": ["Sun", "Mon", "Tue", "Wed", "Thu", "Fri", "Sat"]
      },
      "download": {
        "download": "Download",
        "completed": "Download Completed",
        "tip": "Click to download video",
        "preparing": "Preparing to download (if failed, please do it manually)"
      },
      "menuCommand": {
        "settings": "Settings",
        "titleDateFormat": "Time format settings:",
        "buttonClose": "Close"
      }
    },
    "ja": {
      "dateFormat": {
        "week": ["Êó•", "Êúà", "ÁÅ´", "Ê∞¥", "Êú®", "Èáë", "Âúü"]
      },
      "download": {
        "download": "„ÉÄ„Ç¶„É≥„É≠„Éº„Éâ",
        "completed": "„ÉÄ„Ç¶„É≥„É≠„Éº„ÉâÂÆå‰∫Ü",
        "tip": "„ÇØ„É™„ÉÉ„ÇØ„Åó„Å¶„Éì„Éá„Ç™„Çí„ÉÄ„Ç¶„É≥„É≠„Éº„Éâ",
        "preparing": "„ÉÄ„Ç¶„É≥„É≠„Éº„Éâ„ÅÆÊ∫ñÂÇô‰∏≠ÔºàÂ§±Êïó„Åô„ÇãÂ†¥Âêà„ÅØÊâãÂãï„ÅßË°å„Å£„Å¶„Åè„Å†„Åï„ÅÑÔºâ"
      },
      "menuCommand": {
        "settings": "Ë®≠ÂÆö",
        "titleDateFormat": "ÊôÇÂàªÂΩ¢Âºè„ÅÆË®≠ÂÆö:",
        "buttonClose": "ÈñâÈéñ"
      }
    },
    "fr": {
      "dateFormat": {
        "week": ["Dim", "Lun", "Mar", "Mer", "Jeu", "Ven", "Sam"]
      },
      "download": {
        "download": "t√©l√©charger",
        "completed": "√©l√©chargement termin√©",
        "tip": "Cliquez pour t√©l√©charger la vid√©o",
        "preparing": "Pr√©paration du t√©l√©chargement (en cas d'√©chec, veuillez le faire manuellement)"
      },
      "menuCommand": {
        "settings": "installation",
        "titleDateFormat": "Param√®tres du format de l'heure :",
        "buttonClose": "fermeture"
      }
    },
    "de": {
      "dateFormat": {
        "week": ["Son", "Mon", "Die", "Mit", "Don", "Fre", "Sam"]
      },
      "download": {
        "download": "herunterladen",
        "completed": "Download abgeschlossen",
        "tip": "Klicken Sie hier, um das Video herunterzuladen",
        "preparing": "Vorbereitung f√ºr den Download (falls der Download fehlschl√§gt, f√ºhren Sie ihn bitte manuell durch)"
      },
      "menuCommand": {
        "settings": "aufstellen",
        "titleDateFormat": "Einstellungen f√ºr das Zeitformat:",
        "buttonClose": "Schlie√üung"
      }
    },
    "it": {
      "dateFormat": {
        "week": ["Dom", "Lun", "Mar", "Mer", "Gio", "Ven", "Sab"]
      },
      "download": {
        "download": "scaricamento",
        "completed": "Download completato",
        "tip": "Fare clic per scaricare il video",
        "preparing": "Preparazione per il download (se fallisce, eseguilo manualmente)"
      },
      "menuCommand": {
        "settings": "impostare",
        "titleDateFormat": "Impostazioni del formato dell'ora:",
        "buttonClose": "chiusura"
      }
    },
    "ko": {
      "dateFormat": {
        "week": ["Ïùº", "Ïõî", "Ìôî", "Ïàò", "Î™©", "Í∏à", "ÌÜ†"]
      },
      "download": {
        "download": "Îã§Ïö¥Î°úÎìú",
        "completed": "Îã§Ïö¥Î°úÎìú ÏôÑÎ£å",
        "tip": "ÎπÑÎîîÏò§Î•º Îã§Ïö¥Î°úÎìúÌïòÎ†§Î©¥ ÌÅ¥Î¶≠ÌïòÏÑ∏Ïöî",
        "preparing": "Îã§Ïö¥Î°úÎìú Ï§ÄÎπÑ Ï§ë (Ïã§Ìå®Ìï† Í≤ΩÏö∞ ÏàòÎèôÏúºÎ°ú ÏßÑÌñâÌï¥Ï£ºÏÑ∏Ïöî)"
      },
      "menuCommand": {
        "settings": "ÏÑ§Ï†ï",
        "titleDateFormat": "ÏãúÍ∞Ñ ÌòïÏãù ÏÑ§Ï†ï:",
        "buttonClose": "ÌèêÏáÑ"
      }
    },
    "ru": {
      "dateFormat": {
        "week": ["–í–°", "–ü–ù", "–í–¢", "–°–†", "–ß–¢", "–ü–¢", "–°–ë"]
      },
      "download": {
        "download": "—Å–∫–∞—á–∞—Ç—å",
        "completed": "–ó–∞–≥—Ä—É–∑–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞",
        "tip": "–ù–∞–∂–º–∏—Ç–µ, —á—Ç–æ–±—ã —Å–∫–∞—á–∞—Ç—å –≤–∏–¥–µ–æ",
        "preparing": "–ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –∫ –∑–∞–≥—Ä—É–∑–∫–µ (–µ—Å–ª–∏ –Ω–µ –ø–æ–ª—É—á–∞–µ—Ç—Å—è, —Å–¥–µ–ª–∞–π—Ç–µ —ç—Ç–æ –≤—Ä—É—á–Ω—É—é)"
      },
      "menuCommand": {
        "settings": "–Ω–∞—Å—Ç—Ä–∞–∏–≤–∞—Ç—å",
        "titleDateFormat": "–ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Ñ–æ—Ä–º–∞—Ç–∞ –≤—Ä–µ–º–µ–Ω–∏:",
        "buttonClose": "–∑–∞–∫—Ä—ã—Ç–∏–µ"
      }
    },
    "pt": {
      "dateFormat": {
        "week": ["Dom", "Seg", "Ter", "Qua", "Qui", "Sex", "S√°b"]
      },
      "download": {
        "download": "descargar",
        "completed": "Descarga completa",
        "tip": "Clique para baixar o v√≠deo",
        "preparing": "Prepara√ß√£o para download (se falhar, fa√ßa-o manualmente)"
      },
      "menuCommand": {
        "settings": "configuraci√≥n",
        "titleDateFormat": "Configuraci√≥n de formato de hora:",
        "buttonClose": "cierre"
      }
    },
    "es": {
      "dateFormat": {
        "week": ["DOM", "LUN", "MAR", "MIER", "JUE", "VIE", "S√ÅB"]
      },
      "download": {
        "download": "descargar",
        "completed": "Descarga completa",
        "tip": "Haga clic para descargar el v√≠deo",
        "preparing": "Prepar√°ndose para la descarga (si falla, h√°galo manualmente)"
      },
      "menuCommand": {
        "settings": "configuraci√≥n",
        "titleDateFormat": "Configuraci√≥n de formato de hora:",
        "buttonClose": "cierre"
      }
    },
    "th": {
      "dateFormat": {
        "week": ["‡∏ß‡∏±‡∏ô‡∏≠‡∏≤‡∏ó‡∏¥‡∏ï‡∏¢‡πå", "‡∏ß‡∏±‡∏ô‡∏à‡∏±‡∏ô‡∏ó‡∏£‡πå", "‡∏ß‡∏±‡∏ô‡∏≠‡∏±‡∏á‡∏Ñ‡∏≤‡∏£", "‡∏ß‡∏±‡∏ô‡∏û‡∏∏‡∏ò", " ‡∏ß‡∏±‡∏ô‡∏û‡∏§‡∏´‡∏±‡∏™‡∏ö‡∏î‡∏µ", "‡∏ß‡∏±‡∏ô‡∏®‡∏∏‡∏Å‡∏£‡πå ", "‡∏ß‡∏±‡∏ô‡πÄ‡∏™‡∏≤‡∏£‡πå "]
      },
      "download": {
        "download": "‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î",
        "completed": "‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏°‡∏ö‡∏π‡∏£‡∏ì‡πå",
        "tip": "‡∏Ñ‡∏•‡∏¥‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡∏ß‡∏¥‡∏î‡∏µ‡πÇ‡∏≠",
        "preparing": "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏Å‡∏≤‡∏£‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î (‡∏´‡∏≤‡∏Å‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡∏î‡πâ‡∏ß‡∏¢‡∏ï‡∏ô‡πÄ‡∏≠‡∏á)"
      },
      "menuCommand": {
        "settings": "‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤",
        "titleDateFormat": "‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡πÄ‡∏ß‡∏•‡∏≤Ôºö",
        "buttonClose": "‡∏õ‡∏¥‡∏î"
      }
    },
    "tr": {
      "dateFormat": {
        "week": ["Pazar", "Pazartesi", "Salƒ±", "√áar≈üamba", "Per≈üembe", "Cuma", "Cumartesi"]
      },
      "download": {
        "download": "indirmek",
        "completed": "ƒ∞ndirme tamamlandƒ±",
        "tip": "Videoyu indirmek i√ßin tƒ±klayƒ±n",
        "preparing": "ƒ∞ndirmeye hazƒ±rlanƒ±yor (ba≈üarƒ±sƒ±z olursa l√ºtfen manuel olarak yapƒ±n)"
      },
      "menuCommand": {
        "settings": "kurmak",
        "titleDateFormat": "Saat formatƒ± ayarlarƒ±Ôºö",
        "buttonClose": "kapatma"
      }
    },
    "nl": {
      "dateFormat": {
        "week": ["zondag", "maandag", "dinsdag", "woensdag", "donderdag", "vrijdag", "zaterdag"]
      },
      "download": {
        "download": "downloaden",
        "completed": "Downloaden voltooid",
        "tip": "Klik om video te downloaden",
        "preparing": "Voorbereiden voor downloaden (als dit mislukt, doe dit dan handmatig)"
      },
      "menuCommand": {
        "settings": "opgezet",
        "titleDateFormat": "Instellingen tijdformaat:",
        "buttonClose": "sluiting"
      }
    }
  };
  const Commonlanguage = (_a = language[ScriptConst["lang"]]) != null ? _a : language["en"];

  const FMT = 3;
  let fmt = GM_getValue("fmt", FMT);
  const XSettingsDialog = {
    number: Math.ceil(Math.random() * 1e8),
    formats: [
      { "format": "Do nothing", "example": "N/A" },
      { "format": "yyyy-MM-dd'T'HH:mm:ss", "example": "2025-07-09T22:57:30" },
      { "format": "mmmm d, yyyy hh:mm A", "example": "July 9, 2025 10:57 PM" },
      { "format": "hh:mm A mmm d, yyyy", "example": "10:57 PM Jul 9, 2025" },
      { "format": "HH.mmA¬∑mmm d,yy", "example": "10.57PM¬∑jul 9,25" },
      { "format": "MM/dd/yy HH:mm", "example": "07/09/25 22:57" },
      { "format": "MM/dd/yy HH:mm:ss", "example": "07/09/25 22:57:30" },
      { "format": "W, MM/dd/yy HH:mm", "example": "Wed, 07/09/25 22:57" },
      { "format": "W, MM/dd/yy HH:mm:ss", "example": "Wed, 07/09/25 22:57:30" },
      { "format": "dd.MM.yy HH:mm", "example": "09.07.25 22:57" },
      { "format": "dd.MM.yy HH:mm:ss", "example": "09.07.25 22:57:30" },
      { "format": "dd.MM.yy(W) HH:mm", "example": "09.07.25(Wed) 22:57" },
      { "format": "dd.MM.yy(W) HH:mm:ss", "example": "09.07.25(Wed) 22:57:30" },
      { "format": "yy/MM/dd HH:mm", "example": "25/07/09 22:57" },
      { "format": "yy/MM/dd HH:mm:ss", "example": "25/07/09 22:57:30" },
      { "format": "yy/MM/dd(W) HH:mm", "example": "25/07/09(Wed) 22:57" },
      { "format": "yy/MM/dd(W) HH:mm:ss [ye/mo/da(we) ho:mi:se]", "example": "25/07/09(Wed) 22:57:30 [ye/mo/da(we) ho:mi:se]" },
      { "format": "yy-MM/dd HH:mm", "example": "25-07/09 22:57" },
      { "format": "yy-MM/dd HH:mm'ss", "example": "25-07/09 22:57'30" },
      { "format": "yy-MM/dd(W) HH:mm", "example": "25-07/09(Wed) 22:57" },
      { "format": "yy-MM/dd(W) HH:mm'ss", "example": "25-07/09(Wed) 22:57'30" },
      { "format": "M114-MM-dd HH:mm", "example": "M114-07-09 22:57" },
      { "format": "M114-MM-dd HH:mm:ss", "example": "M114-07-09 22:57:30" },
      { "format": "M114-MM-dd(W) HH:mm", "example": "M114-07-09(Wed) 22:57" },
      { "format": "M114-MM-dd(W) HH:mm:ss", "example": "M114-07-09(Wed) 22:57:30" },
      { "format": "W, mmmm d, yyyy hh:mm:ss A", "example": "Wednesday, July 9, 2025 10:57:30 PM" }
    ],
    make: function() {
      let dialog = document.createElement("div");
      dialog.className = "dialog_u_" + this.number;
      dialog.style.all = "initial";
      dialog.style.backgroundColor = "rgb(255, 255, 255)";
      dialog.style.border = "1px solid #ccc";
      dialog.style.borderRadius = "2px";
      dialog.style.display = "none";
      dialog.style.fontFamily = "monospace";
      dialog.style.fontSize = "12px";
      dialog.style.width = "480px";
      dialog.style.paddingLeft = "5px";
      dialog.style.paddingRight = "5px";
      dialog.style.paddingTop = "5px";
      dialog.style.paddingBottom = "5px";
      dialog.style.position = "fixed";
      dialog.style.right = "8px";
      dialog.style.top = "8px";
      dialog.style.zIndex = "2147483647";
      dialog.style.overflow = "auto";
      let formatsHtml = `<table style="width:100%;border: 1px solid #c0bfbf;border-collapse: collapse;">`;
      for (var i = 1; i <= this.formats.length; i++) {
        if (i % 2 != 0) {
          formatsHtml += `<tr style="width:100%;border: 1px solid #c0bfbf;">`;
        }
        formatsHtml += `<td width="50" style="border: 1px solid #c0bfbf;padding: 5px;" title="` + this.formats[i - 1].example + `"><input type="radio" name="fmt" value="` + (i - 1) + `" class="top_r" />` + ("„Äê" + i + "„Äë" + this.formats[i - 1].format) + `</td>`;
        if (i % 2 == 0) {
          formatsHtml += `</tr>`;
        }
      }
      formatsHtml += `</table>`;
      let html = `
        <div style="font-size:15px;font-weight:bold;margin-bottom:5px;">` + Commonlanguage.menuCommand.titleDateFormat + `</div>
        <div>` + formatsHtml + `</div>
        <div style="margin-top:15px;text-align:center;">
          <button name="closex">` + Commonlanguage.menuCommand.buttonClose + `</button>
        </div>
      `;
      dialog.innerHTML = html;
      return dialog;
    },
    addEvent: function(dialog) {
      dialog.querySelector("button[name='closex']").addEventListener("click", function(event) {
        for (let e of dialog.querySelectorAll('input[name="fmt"]')) {
          if (e.checked) {
            fmt = e.value;
            break;
          }
        }
        GM_setValue("fmt", fmt);
        dialog.style.display = "none";
      }, false);
    },
    init: function() {
      let dialog = this.make();
      this.addEvent(dialog);
      document.body.appendChild(dialog);
      GM_registerMenuCommand(Commonlanguage.menuCommand.settings, function() {
        if (dialog.style.display == "none") {
          dialog.querySelector('input[name="fmt"][value="' + fmt + '"]').checked = true;
          dialog.style.display = "block";
        }
      });
    }
  };
  const XDateFormat = {
    df: function(date, f) {
      var _a;
      const WEEK = Commonlanguage.dateFormat.week;
      const WEEK_FULL = ["Sunday", "Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday"];
      const MONTH_SHORT = ["Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"];
      const MONTH_FULL = ["January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"];
      const pad = (num) => ("0" + num).slice(-2);
      const YE = date.getFullYear();
      const YE2 = YE.toString().slice(-2);
      const YM = YE - 1911;
      const MO = pad(date.getMonth() + 1);
      const MO_IDX = date.getMonth();
      const MO_NAME = MONTH_SHORT[MO_IDX];
      const MO_NAME_FULL = MONTH_FULL[MO_IDX];
      const DA = pad(date.getDate());
      const WE = WEEK[date.getDay()];
      const WE_FULL = WEEK_FULL[date.getDay()];
      const HO = pad(date.getHours());
      const MI = pad(date.getMinutes());
      const SE = pad(date.getSeconds());
      const h12 = date.getHours() % 12 || 12;
      const HO12 = pad(h12);
      const AMPM = date.getHours() >= 12 ? "PM" : "AM";
      const F = [
        `${YE}-${MO}-${DA}T${HO}:${MI}:${SE}`,
        `${MO_NAME_FULL} ${parseInt(DA)}, ${YE} ${HO12}:${MI} ${AMPM}`,
        `${HO12}:${MI} ${AMPM} ${MO_NAME} ${parseInt(DA)}, ${YE}`,
        `${HO12}.${MI}${AMPM}¬∑${MO_NAME.toLowerCase()} ${parseInt(DA)},${YE2}`,
        `${MO}/${DA}/${YE2} ${HO}:${MI}`,
        `${MO}/${DA}/${YE2} ${HO}:${MI}:${SE}`,
        `${WE}, ${MO}/${DA}/${YE2} ${HO}:${MI}`,
        `${WE}, ${MO}/${DA}/${YE2} ${HO}:${MI}:${SE}`,
        `${DA}.${MO}.${YE2} ${HO}:${MI}`,
        `${DA}.${MO}.${YE2} ${HO}:${MI}:${SE}`,
        `${DA}.${MO}.${YE2}(${WE}) ${HO}:${MI}`,
        `${DA}.${MO}.${YE2}(${WE}) ${HO}:${MI}:${SE}`,
        `${YE2}/${MO}/${DA} ${HO}:${MI}`,
        `${YE2}/${MO}/${DA} ${HO}:${MI}:${SE}`,
        `${YE2}/${MO}/${DA}(${WE}) ${HO}:${MI}`,
        `${YE2}/${MO}/${DA}(${WE}) ${HO}:${MI}:${SE} [ye/mo/da(we) ho:mi:se]`,
        `${YE2}-${MO}/${DA} ${HO}:${MI}`,
        `${YE2}-${MO}/${DA} ${HO}:${MI}'${SE}`,
        `${YE2}-${MO}/${DA}(${WE}) ${HO}:${MI}`,
        `${YE2}-${MO}/${DA}(${WE}) ${HO}:${MI}'${SE}`,
        `M${YM}-${MO}-${DA} ${HO}:${MI}`,
        `M${YM}-${MO}-${DA} ${HO}:${MI}:${SE}`,
        `M${YM}-${MO}-${DA}(${WE}) ${HO}:${MI}`,
        `M${YM}-${MO}-${DA}(${WE}) ${HO}:${MI}:${SE}`,
        `${WE_FULL}, ${MO_NAME_FULL} ${parseInt(DA)}, ${YE} ${HO12}:${MI}:${SE} ${AMPM}`
      ];
      return (_a = F[f]) != null ? _a : F[0];
    },
    repldatetime: function() {
      const MYNAME = "peter_parker_x1190";
      const SEL = 'main div[data-testid="primaryColumn"] section article time[datetime*=":"]';
      const SEL_2 = 'div[aria-labelledby="modal-header"] div[data-testid^="User-Name"] time[datetime]';
      const SEL_3 = 'div[aria-labelledby="modal-header"] div[aria-label] time[datetime]';
      const SEL_4 = 'main section[aria-labelledby="detail-header"] article div[data-testid^="User-Name"] time[datetime]';
      const SEL_5 = 'main section div[data-testid="conversation"] div[aria-label] time[datetime]';
      document.querySelectorAll(SEL + ", " + SEL_2 + ", " + SEL_3 + ", " + SEL_4 + ", " + SEL_5).forEach((e) => {
        if (fmt != 0) {
          const SEL_ADD = "span.us-" + MYNAME;
          let d = e.getAttribute("datetime");
          let df = this.df(new Date(d), fmt - 1);
          let pe = e.parentNode;
          let old = pe.querySelectorAll(SEL_ADD);
          if (!old.length) {
            let span = document.createElement("span");
            span.className = "us-" + MYNAME;
            span.setAttribute("datetime", d);
            span.setAttribute("local-datetime", df);
            span.textContent = df;
            span.style = e.style;
            e.style.setProperty("display", "none");
            pe.appendChild(span);
          } else if (old[0].getAttribute("local-datetime") != df) {
            old[0].setAttribute("local-datetime", df);
            old[0].textContent = df;
            old[0].style = e.style;
          }
        }
      });
    }
  };
  const XDownloadUI = {
    showSensitive: true,
    svg: `
        <g class="download"><path d="M11.99 16l-5.7-5.7L7.7 8.88l3.29 3.3V2.59h2v9.59l3.3-3.3 1.41 1.42-5.71 5.7zM21 15l-.02 3.51c0 1.38-1.12 2.49-2.5 2.49H5.5C4.11 21 3 19.88 3 18.5V15h2v3.5c0 .28.22.5.5.5h12.98c.28 0 .5-.22.5-.5L19 15h2z" /></g>
        <g class="completed"><path d="M3,14 v5 q0,2 2,2 h14 q2,0 2,-2 v-5 M7,10 l3,4 q1,1 2,0 l8,-11" fill="none" stroke="#1DA1F2" stroke-width="2" stroke-linecap="round" /></g>
        <g class="loading"><circle cx="12" cy="12" r="10" fill="none" stroke="#1DA1F2" stroke-width="4" opacity="0.4" /><path d="M12,2 a10,10 0 0 1 10,10" fill="none" stroke="#1DA1F2" stroke-width="4" stroke-linecap="round" /></g>
        <g class="failed"><circle cx="12" cy="12" r="11" fill="#f33" stroke="currentColor" stroke-width="2" opacity="0.8" /><path d="M14,5 a1,1 0 0 0 -4,0 l0.5,9.5 a1.5,1.5 0 0 0 3,0 z M12,17 a2,2 0 0 0 0,4 a2,2 0 0 0 0,-4" fill="#fff" stroke="none" /></g>
    `,
    isTweetdeck: () => window.location.host.includes("tweetdeck"),
    extractStatusId: (url) => url ? (url.match(/\/status\/(\d+)/) || [null, null])[1] : null,
    uniqueArray: (arr) => Array.from(new Set(arr)),
    getExtension: (url) => new URL(url).pathname.split(".").pop() || null,
    sanitizeFilename: (filename) => filename.replace(/[\/\\\?\%\*\:\|\\"<>\r\n]/g, "_"),
    setStatus: function(btn, classnames, title, style) {
      if (classnames) {
        btn.classList.remove("download", "completed", "loading", "failed");
        btn.classList.add(...classnames);
      }
      if (title)
        btn.title = title;
      if (style)
        btn.style.cssText = style;
    },
    clickDownloadEvent: function(btn, statusIds) {
      const uniqueStatusIds = this.uniqueArray(statusIds);
      console.log("%c[Video Downloader] Media Links", "color: #1DA1F2; font-size: 16px; font-weight: bold;");
      console.log("=".repeat(60));
      
      let foundAny = false;
      uniqueStatusIds.forEach((statusId) => {
        const media = XDownload.mediaMap.get(statusId);
        if (media) {
          foundAny = true;
          console.log("%cTweet ID: " + statusId, "color: #1DA1F2; font-weight: bold;");
          console.log("%cText: " + media.text, "color: #666;");
          if (media.video) {
            console.log("%cüé¨ Video URL:", "color: #4CAF50;", media.video);
          }
          if (media.photo) {
            console.log("%cüì∑ Photo URL:", "color: #2196F3;", media.photo);
          }
          if (media.thumbnail) {
            console.log("%cüñºÔ∏è Thumbnail:", "color: #FF9800;", media.thumbnail);
          }
          console.log("-".repeat(40));
        }
      });
      
      if (!foundAny) {
        console.log("%c‚ö†Ô∏è No media found for the selected tweet(s)", "color: #f44336;");
      }
      
      console.log("=".repeat(60));
      this.setStatus(btn, ["completed"], "Links logged to console");
    },
    addButtonTo: function(article) {
      var _a, _b;
      if (article.dataset.detected)
        return;
      article.dataset.detected = "true";
      const statusIds = Array.from(article.querySelectorAll('a[href*="/status/"]')).map((el) => this.extractStatusId(el.href)).filter((id) => id);
      if (statusIds.length === 0)
        return;
      const mediaSelector = [
        'a[href*="/photo/1"]',
        'div[role="progressbar"]',
        'button[data-testid="playButton"]',
        'div[data-testid="videoComponent"]',
        'a[href="/settings/content_you_see"]',
        "div.media-image-container",
        "div.media-preview-container",
        'div[aria-labelledby]>div:first-child>div[role="button"][tabindex="0"]'
      ];
      const hasMedia = article.querySelector(mediaSelector.join(","));
      if (hasMedia) {
        const btnGroup = article.querySelector('div[role="group"]:last-of-type, ul.tweet-actions, ul.tweet-detail-actions');
        if (btnGroup) {
          const btnShare = Array.from(btnGroup.querySelectorAll(":scope>div>div, li.tweet-action-item>a, li.tweet-detail-action-item>a")).pop().parentNode;
          const btnDownload = btnShare.cloneNode(true);
          btnDownload.style.marginLeft = "10px";
          (_a = btnDownload.querySelector("button")) == null ? void 0 : _a.removeAttribute("disabled");
          const svgContainer = this.isTweetdeck() ? btnDownload.firstElementChild : btnDownload.querySelector("svg");
          if (svgContainer) {
            if (this.isTweetdeck()) {
              svgContainer.innerHTML = `<svg viewBox="0 0 20 20" width="15" height="15">${this.svg}</svg>`;
              svgContainer.removeAttribute("rel");
              btnDownload.classList.replace("pull-left", "pull-right");
            } else {
              svgContainer.innerHTML = this.svg;
            }
          }
          this.setStatus(btnDownload, ["x-master-dl", "download"], "‰∏ãËΩΩÂ™í‰Ωì");
          btnGroup.insertBefore(btnDownload, btnShare.nextSibling);
          btnDownload.onclick = () => this.clickDownloadEvent(btnDownload, statusIds);
          if (this.showSensitive) {
            (_b = article.querySelector('div[aria-labelledby] div[role="button"][tabindex="0"]:not([data-testid]) > div[dir] > span > span')) == null ? void 0 : _b.click();
          }
        }
      }
      const imgs = article.querySelectorAll('a[href*="/photo/"]');
      if (imgs.length > 1) {
        imgs.forEach((img) => {
          const imgStatusId = this.extractStatusId(img.href);
          if (!imgStatusId || img.parentNode.querySelector(".x-master-dl.tmd-img"))
            return;
          const btnDownload = document.createElement("div");
          btnDownload.style.cssText = "position: absolute; top: 0; right: 0; z-index: 10; margin: 5px;";
          btnDownload.innerHTML = `<div><div><svg viewBox="0 0 20 20" width="15" height="15">${this.svg}</svg></div></div>`;
          this.setStatus(btnDownload, ["x-master-dl", "tmd-img", "download"], "‰∏ãËΩΩÂõæÁâá");
          img.parentNode.appendChild(btnDownload);
          btnDownload.onclick = (e) => {
            e.preventDefault();
            e.stopPropagation();
            this.clickDownloadEvent(btnDownload, [imgStatusId]);
          };
        });
      }
    },
    addButtonToMedia: function(listitems) {
      listitems.forEach((li) => {
        if (li.dataset.detected)
          return;
        li.dataset.detected = "true";
        const statusElement = li.querySelector('a[href*="/status/"]');
        const statusId = statusElement ? this.extractStatusId(statusElement.href) : null;
        if (!statusId)
          return;
        const btnDownload = document.createElement("div");
        btnDownload.innerHTML = `<div><div><svg viewBox="0 0 20 20" width="15" height="15">${this.svg}</svg></div></div>`;
        this.setStatus(btnDownload, ["x-master-dl", "tmd-media", "download"], "‰∏ãËΩΩÂ™í‰Ωì");
        li.appendChild(btnDownload);
        btnDownload.onclick = () => this.clickDownloadEvent(btnDownload, [statusId]);
      });
    },
    detect: function(node) {
      const article = node.tagName === "ARTICLE" && node || node.tagName === "DIV" && (node.querySelector("article") || node.closest("article"));
      if (article) {
        this.addButtonTo(article);
      }
      const listitems = node.tagName === "LI" && node.getAttribute("role") === "listitem" ? [node] : node.tagName === "DIV" && node.querySelectorAll('li[role="listitem"]');
      if (listitems) {
        this.addButtonToMedia(listitems);
      }
    }
  };
  const XDownload = {
    mediaMap: /* @__PURE__ */ new Map(),
    findParent: function(obj, targetKey) {
      let result = [];
      if (typeof obj === "object" && obj !== null) {
        for (let key in obj) {
          if (obj.hasOwnProperty(key)) {
            if (key === targetKey) {
              result.push(obj);
            }
            result = result.concat(this.findParent(obj[key], targetKey));
          }
        }
      } else if (Array.isArray(obj)) {
        for (let item of obj) {
          result = result.concat(this.findParent(item, targetKey));
        }
      }
      return result;
    },
    extractMediaFromResponse: function(url, responseText) {
      try {
        const data = JSON.parse(responseText);
        const entities = this.findParent(data, "extended_entities");
        if (entities.length === 0) {
          return;
        }
        for (let entity of entities) {
          if (!entity.extended_entities)
            continue;
          const entityId = entity.id_str || entity.conversation_id_str;
          (entity.extended_entities.media || []).filter((m) => ["video", "animated_gif", "photo"].includes(m.type)).forEach((m) => {
            var _a, _b, _c, _d, _e;
            const bestVideo = (_b = (_a = m.video_info) == null ? void 0 : _a.variants) == null ? void 0 : _b.filter((v) => v.content_type === "video/mp4").sort((a, b) => b.bitrate - a.bitrate)[0];
            const text = ((_d = (_c = (entity.full_text || "").split("https://t.co")[0]) == null ? void 0 : _c.trim()) == null ? void 0 : _d.slice(0, 50)) || entityId;
            const mediaItem = {
              entityId,
              id: m.id_str,
              thumbnail: (_e = m.media_url_https) == null ? void 0 : _e.split(".jpg")[0],
              video: bestVideo == null ? void 0 : bestVideo.url,
              photo: m.media_url_https,
              text
            };
            this.mediaMap.set(entityId, mediaItem);
          });
        }
      } catch (e) {
      }
    },
    hookXMLHttpRequest: function() {
      const self = this;
      const originalOpen = XMLHttpRequest.prototype.open;
      const originalSend = XMLHttpRequest.prototype.send;
      XMLHttpRequest.prototype.open = function(method, url) {
        this._url = url;
        return originalOpen.apply(this, arguments);
      };
      XMLHttpRequest.prototype.send = function() {
        this.addEventListener("load", function() {
          if (this._url && this.response) {
            try {
              if (this.responseType === "" || this.responseType === "text") {
                self.extractMediaFromResponse(this._url, this.responseText);
              }
            } catch (e) {
            }
          }
        });
        return originalSend.apply(this, arguments);
      };
    },
    init: function() {
      this.hookXMLHttpRequest();
      GM_addStyle(css_248z + (this.showSensitive ? css_248z$1 : ""));
    }
  };
  const X = {
    start: function() {
      XDownload.init();
      XSettingsDialog.init();
      const observer = new MutationObserver((mutations) => {
        mutations.forEach((mutation) => {
          mutation.addedNodes.forEach((node) => {
            if (node.nodeType === 1) {
              XDownloadUI.detect(node);
              XDateFormat.repldatetime();
            }
          });
        });
      });
      observer.observe(document.body, {
        childList: true,
        subtree: true
      });
    }
  };

  var __async$1 = (__this, __arguments, generator) => {
    return new Promise((resolve, reject) => {
      var fulfilled = (value) => {
        try {
          step(generator.next(value));
        } catch (e) {
          reject(e);
        }
      };
      var rejected = (value) => {
        try {
          step(generator.throw(value));
        } catch (e) {
          reject(e);
        }
      };
      var step = (x) => x.done ? resolve(x.value) : Promise.resolve(x.value).then(fulfilled, rejected);
      step((generator = generator.apply(__this, __arguments)).next());
    });
  };
  const Tiktok = {
    download: function(playId) {
      if (playId) {
        Tools.openInTab("https://www.tikfork.com/en/tk?s=10&url=https://www.tiktok.com/@/video/" + playId);
      }
    },
    downloadSVG: `<svg t="1751880898865" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="5364" width="22" height="22"><path d="M860 64H164c-55.2 0-100 44.8-100 100v696c0 55.2 44.8 100 100 100h696c55.2 0 100-44.8 100-100V164c0-55.2-44.8-100-100-100zM709.5 566.4L536.9 764.3c-13.2 15.1-36.6 15.1-49.8 0L314.5 566.4c-15.5-17.8-2.9-45.5 20.7-45.5h119.7V284.5c0-19.9 16.1-36.1 36.1-36.1h42c19.9 0 36.1 16.1 36.1 36.1v236.4h119.7c23.6-0.1 36.2 27.7 20.7 45.5z" fill="#FFFFFF" p-id="5365"></path></svg>`,
    findAncestorByClass: function(element, className, maxDepth = Infinity) {
      let current = element;
      let depth = 0;
      while (current && depth < maxDepth) {
        current = current.parentElement;
        depth++;
        if (current && current.classList.contains(className)) {
          return current;
        }
      }
      return null;
    },
    extractLastDashNumber: function(str) {
      if (!str)
        return null;
      const match = str.match(/-(\d+)$/);
      return match ? match[1] : null;
    },
    start: function() {
      return __async$1(this, null, function* () {
        if (!/www\.tiktok\.com/.test(window.location.host)) {
          return;
        }
        const randomId = Math.floor(1e5 + Math.random() * 9e5);
        GM_addStyle(`
      .sc-download-` + randomId + `{
        cursor:pointer;
        justify-content:center;
        align-items:center;
        width:48px;
        height:48px;
        z-index:99999;position:absolute;right:55px;top:0px;border-radius:50%;
        display: flex;
      }
    `);
        setInterval(() => {
          document.querySelectorAll("video").forEach((element, index) => {
            const parentNode = element.parentNode;
            if (!parentNode.querySelector("*[x-add='true']")) {
              const downloadElement = document.createElement("div");
              downloadElement.setAttribute("x-add", "true");
              downloadElement.classList.add("sc-download-" + randomId);
              downloadElement.innerHTML = this.downloadSVG;
              parentNode.appendChild(downloadElement);
              downloadElement.addEventListener("click", () => {
                const container = this.findAncestorByClass(parentNode, "xgplayer-container", 3);
                if (container && container.getAttribute("id")) {
                  const playId = this.extractLastDashNumber(container.getAttribute("id"));
                  if (playId)
                    this.download(playId);
                }
              });
            }
          });
        }, 1e3);
      });
    }
  };

  const AllModules = {
    X,
    Tiktok
  };

  var __async = (__this, __arguments, generator) => {
    return new Promise((resolve, reject) => {
      var fulfilled = (value) => {
        try {
          step(generator.next(value));
        } catch (e) {
          reject(e);
        }
      };
      var rejected = (value) => {
        try {
          step(generator.throw(value));
        } catch (e) {
          reject(e);
        }
      };
      var step = (x) => x.done ? resolve(x.value) : Promise.resolve(x.value).then(fulfilled, rejected);
      step((generator = generator.apply(__this, __arguments)).next());
    });
  };
  const Init = {
    x: function() {
      AllModules.X.start();
    },
    tiktok: function() {
      AllModules.Tiktok.start();
    },
    unknown: function() {
    },
    start: function() {
      return __async(this, null, function* () {
        const otherPlatform = Tools.getOtherPlatform();
        if (otherPlatform) {
          try {
            yield Tools.getDocumentBody();
            this[otherPlatform]();
          } catch (e) {
          }
        }
      });
    }
  };
  Init.start();

}());
